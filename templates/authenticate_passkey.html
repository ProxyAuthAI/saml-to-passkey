{% extends "base.html" %} {% block title %}Authenticate with Passkey{% endblock
%} {% block content %}
<h1>üîê Sign In</h1>
<h2>Authenticate with your passkey</h2>

{% if has_saml_session %}
<div class="message info">
  You're being authenticated for a SAML application.
</div>
{% endif %}

<button class="btn" onclick="authenticateWithPasskey()">
  <span id="btnText">Sign In with Passkey</span>
  <span id="btnSpinner" class="spinner hidden"></span>
</button>

<div id="result" class="hidden"></div>

<div
  style="
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    text-align: center;
  "
>
  <p style="color: #666; font-size: 14px">
    Don't have a passkey?
    <a href="/" style="color: #667eea; text-decoration: none; font-weight: 600"
      >Register one here</a
    >
  </p>
</div>
{% endblock %} {% block scripts %}
<script>
  let challengeKey = null;

  // Helper function to convert base64url to ArrayBuffer
  function base64urlToBuffer(base64url) {
    const base64 = base64url.replace(/-/g, "+").replace(/_/g, "/");
    const padLen = (4 - (base64.length % 4)) % 4;
    const padded = base64 + "=".repeat(padLen);
    const binary = atob(padded);
    const buffer = new ArrayBuffer(binary.length);
    const view = new Uint8Array(buffer);
    for (let i = 0; i < binary.length; i++) {
      view[i] = binary.charCodeAt(i);
    }
    return buffer;
  }

  // Helper function to convert ArrayBuffer to base64url
  function bufferToBase64url(buffer) {
    const binary = String.fromCharCode(...new Uint8Array(buffer));
    const base64 = btoa(binary);
    return base64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
  }

  async function authenticateWithPasskey() {
    const resultDiv = document.getElementById("result");
    const btnText = document.getElementById("btnText");
    const btnSpinner = document.getElementById("btnSpinner");
    const btn = document.querySelector(".btn");

    // Show loading state
    btn.disabled = true;
    btnText.classList.add("hidden");
    btnSpinner.classList.remove("hidden");
    resultDiv.classList.add("hidden");

    try {
      // Step 1: Get authentication options from server
      showMessage("Requesting authentication options...", "info");

      const optionsResponse = await fetch("/api/passkey/auth/options", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({}),
      });

      if (!optionsResponse.ok) {
        const errorData = await optionsResponse.json();
        throw new Error(
          errorData.error || "Failed to get authentication options",
        );
      }

      const options = await optionsResponse.json();
      challengeKey = options.challenge_key;

      // Convert base64url strings to ArrayBuffers
      options.challenge = base64urlToBuffer(options.challenge);

      if (options.allowCredentials) {
        options.allowCredentials = options.allowCredentials.map((cred) => ({
          ...cred,
          id: base64urlToBuffer(cred.id),
        }));
      }

      // Step 2: Get credential
      showMessage("Please use your authenticator...", "info");

      const credential = await navigator.credentials.get({
        publicKey: options,
      });

      // Step 3: Send credential to server for verification
      showMessage("Verifying authentication...", "info");

      const credentialForServer = {
        id: credential.id,
        rawId: bufferToBase64url(credential.rawId),
        type: credential.type,
        response: {
          clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
          authenticatorData: bufferToBase64url(
            credential.response.authenticatorData,
          ),
          signature: bufferToBase64url(credential.response.signature),
          userHandle: credential.response.userHandle
            ? bufferToBase64url(credential.response.userHandle)
            : null,
        },
      };

      const verifyResponse = await fetch("/api/passkey/auth/verify", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          challenge_key: challengeKey,
          credential: credentialForServer,
        }),
      });

      if (!verifyResponse.ok) {
        const errorData = await verifyResponse.json();
        throw new Error(errorData.error || "Authentication failed");
      }

      const result = await verifyResponse.json();

      // Success!
      if (result.redirect_url) {
        // Redirect to SAML response
        showMessage("Authentication successful! Redirecting...", "success");
        setTimeout(() => {
          window.location.href = result.redirect_url;
        }, 1000);
      } else {
        resultDiv.className = "message success";
        resultDiv.innerHTML = `
                <strong>Success!</strong><br>
                You have been authenticated successfully.<br>
                User: ${result.email}
            `;
        resultDiv.classList.remove("hidden");

        btnText.textContent = "Authenticated ‚úì";
        btnText.classList.remove("hidden");
        btnSpinner.classList.add("hidden");
      }
    } catch (error) {
      console.error("Error:", error);
      resultDiv.className = "message error";
      resultDiv.textContent = "Error: " + error.message;
      resultDiv.classList.remove("hidden");

      // Reset button state
      btn.disabled = false;
      btnText.classList.remove("hidden");
      btnSpinner.classList.add("hidden");
    }
  }

  function showMessage(text, type) {
    const resultDiv = document.getElementById("result");
    resultDiv.className = "message " + type;
    resultDiv.textContent = text;
    resultDiv.classList.remove("hidden");
  }
</script>
{% endblock %}
