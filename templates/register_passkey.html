{% extends "base.html" %} {% block title %}Register Your Passkey{% endblock %}
{% block content %}
<h1>ðŸ”‘ Register Your Passkey</h1>
<h2>One-time setup for passwordless authentication</h2>

<div class="message info">
  You're registering a passkey for: <strong>{{ email }}</strong>
</div>

<div style="margin: 20px 0">
  <p style="color: #666; line-height: 1.6">
    Click the button below to create a passkey using your device's authenticator
    (fingerprint, face recognition, or security key).
  </p>
</div>

<button class="btn" onclick="registerPasskey()">
  <span id="btnText">Create Passkey</span>
  <span id="btnSpinner" class="spinner hidden"></span>
</button>

<div id="result" class="hidden"></div>
{% endblock %} {% block scripts %}
<script>
  const userId = "{{ user_id }}";
  const token = "{{ token }}";

  // Helper function to convert base64url to ArrayBuffer
  function base64urlToBuffer(base64url) {
    const base64 = base64url.replace(/-/g, "+").replace(/_/g, "/");
    const padLen = (4 - (base64.length % 4)) % 4;
    const padded = base64 + "=".repeat(padLen);
    const binary = atob(padded);
    const buffer = new ArrayBuffer(binary.length);
    const view = new Uint8Array(buffer);
    for (let i = 0; i < binary.length; i++) {
      view[i] = binary.charCodeAt(i);
    }
    return buffer;
  }

  // Helper function to convert ArrayBuffer to base64url
  function bufferToBase64url(buffer) {
    const binary = String.fromCharCode(...new Uint8Array(buffer));
    const base64 = btoa(binary);
    return base64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
  }

  async function registerPasskey() {
    const resultDiv = document.getElementById("result");
    const btnText = document.getElementById("btnText");
    const btnSpinner = document.getElementById("btnSpinner");
    const btn = document.querySelector(".btn");

    // Show loading state
    btn.disabled = true;
    btnText.classList.add("hidden");
    btnSpinner.classList.remove("hidden");
    resultDiv.classList.add("hidden");

    try {
      // Step 1: Get registration options from server
      showMessage("Requesting registration options...", "info");

      const optionsResponse = await fetch("/api/passkey/register/options", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ user_id: userId, token: token }),
      });

      if (!optionsResponse.ok) {
        throw new Error("Failed to get registration options");
      }

      const options = await optionsResponse.json();

      // Convert base64url strings to ArrayBuffers
      options.challenge = base64urlToBuffer(options.challenge);
      options.user.id = base64urlToBuffer(options.user.id);

      if (options.excludeCredentials) {
        options.excludeCredentials = options.excludeCredentials.map((cred) => ({
          ...cred,
          id: base64urlToBuffer(cred.id),
        }));
      }

      // Step 2: Create credential
      showMessage("Please use your authenticator...", "info");

      const credential = await navigator.credentials.create({
        publicKey: options,
      });

      // Step 3: Send credential to server for verification
      showMessage("Verifying passkey...", "info");

      const credentialForServer = {
        id: credential.id,
        rawId: bufferToBase64url(credential.rawId),
        type: credential.type,
        response: {
          clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
          attestationObject: bufferToBase64url(
            credential.response.attestationObject,
          ),
        },
      };

      const verifyResponse = await fetch("/api/passkey/register/verify", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          user_id: userId,
          credential: credentialForServer,
        }),
      });

      if (!verifyResponse.ok) {
        throw new Error("Failed to verify passkey");
      }

      const result = await verifyResponse.json();

      // Success!
      resultDiv.className = "message success";
      resultDiv.innerHTML = `
            <strong>Success!</strong><br>
            Your passkey has been registered. You can now use it to authenticate.<br><br>
            <a href="/auth/passkey" style="color: #3c3; font-weight: 600;">Go to Login Page</a>
        `;
      resultDiv.classList.remove("hidden");

      // Keep button disabled after success
      btnText.textContent = "Passkey Registered âœ“";
      btnText.classList.remove("hidden");
      btnSpinner.classList.add("hidden");
    } catch (error) {
      console.error("Error:", error);
      resultDiv.className = "message error";
      resultDiv.textContent = "Error: " + error.message;
      resultDiv.classList.remove("hidden");

      // Reset button state
      btn.disabled = false;
      btnText.classList.remove("hidden");
      btnSpinner.classList.add("hidden");
    }
  }

  function showMessage(text, type) {
    const resultDiv = document.getElementById("result");
    resultDiv.className = "message " + type;
    resultDiv.textContent = text;
    resultDiv.classList.remove("hidden");
  }
</script>
{% endblock %}
