{% extends "base.html" %} {% block title %}SAML Passkey IdP - Home{% endblock %}
{% block content %}
<h1>üîê SAML Passkey IdP</h1>
<h2>Secure authentication with passkeys</h2>

<div class="message info">
  <strong>Welcome!</strong> This is a SAML 2.0 Identity Provider that uses
  passkeys (WebAuthn) for authentication.
</div>

<div style="margin: 30px 0">
  <h3 style="margin-bottom: 15px; color: #333">Getting Started</h3>
  <ol style="color: #666; line-height: 1.8; padding-left: 20px">
    <li>Request a magic link to register your passkey</li>
    <li>
      Use your passkey to authenticate when accessing SAML-protected
      applications
    </li>
  </ol>
</div>

<div class="form-group">
  <label for="email">Request Passkey Registration Link</label>
  <input
    type="email"
    id="email"
    placeholder="your.email@example.com"
    required
  />
</div>

<button class="btn" onclick="requestMagicLink()">
  <span id="btnText">Get Registration Link</span>
  <span id="btnSpinner" class="spinner hidden"></span>
</button>

<div id="result" class="hidden"></div>

<div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee">
  <h3 style="margin-bottom: 15px; color: #333">For Developers</h3>
  <p style="color: #666; font-size: 14px; line-height: 1.6">
    SAML Metadata URL: <br />
    <code
      style="
        background: #f5f5f5;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 5px;
      "
    >
      {{ request.url_root }}saml/metadata
    </code>
  </p>
</div>
{% endblock %} {% block scripts %}
<script>
  async function requestMagicLink() {
    const email = document.getElementById("email").value;
    const resultDiv = document.getElementById("result");
    const btnText = document.getElementById("btnText");
    const btnSpinner = document.getElementById("btnSpinner");
    const btn = document.querySelector(".btn");

    if (!email) {
      showMessage("Please enter your email address", "error");
      return;
    }

    // Show loading state
    btn.disabled = true;
    btnText.classList.add("hidden");
    btnSpinner.classList.remove("hidden");
    resultDiv.classList.add("hidden");

    try {
      const response = await fetch("/magic-link/generate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();

      if (response.ok) {
        resultDiv.className = "message success";
        resultDiv.innerHTML = `
                <strong>Success!</strong><br>
                ${data.message}<br><br>
                <strong>Registration Link:</strong><br>
                <a href="${data.magic_link}" style="color: #3c3; word-break: break-all;">
                    ${data.magic_link}
                </a>
            `;
        resultDiv.classList.remove("hidden");
      } else {
        showMessage(data.error || "Failed to generate magic link", "error");
      }
    } catch (error) {
      showMessage("Network error: " + error.message, "error");
    } finally {
      // Reset button state
      btn.disabled = false;
      btnText.classList.remove("hidden");
      btnSpinner.classList.add("hidden");
    }
  }

  function showMessage(text, type) {
    const resultDiv = document.getElementById("result");
    resultDiv.className = "message " + type;
    resultDiv.textContent = text;
    resultDiv.classList.remove("hidden");
  }

  // Allow Enter key to submit
  document.getElementById("email").addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      requestMagicLink();
    }
  });
</script>
{% endblock %}
